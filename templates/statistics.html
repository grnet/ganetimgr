{% extends "theme/base.html" %}
{% load i18n %}
{% block extrahead %}
<script type="text/javascript" src="/static/js/highcharts.js"></script>
<script type="text/javascript">

$(function () {

	
	
	var options = {
	        chart: {
	        	zoomType: 'x',
	            renderTo: 'container'
	        },
	        title: {
                text: 'Instance Creation History'
            },
            subtitle: {
                text: document.ontouchstart === undefined ?
                    'Click and drag in the plot area to zoom in' :
                    'Drag your finger over the plot to zoom in'
            },
	        xAxis: {
	            type:'datetime',
	            maxZoom: 14 * 24 * 3600000, // fourteen days
	            title: {
                    text: "Instance Creation Dates"
                }
	        },
	        yAxis: {
	        	min: 0,
	            title: {
                    text: "Number of Instances"
                }
	        },
	        series: [],
	        tooltip: {
	            shared: false,
	            formatter: function() {
	                var s = this.point.vm;
	                return '<b>'+s + '</b><hr/><br/><b>Created: </b>' + new Date(this.point.x).toDateString() + '<br/>So far: ' + this.y;
	            }
	        }
	    };
	
	$.getJSON('{% url stats_ajax_instances %}', function(dt) {
		var items = [];
		$.each(dt, function(i, item) {
			options.series.push({
                data: [],
                name: item.name
            });
			for (var j=0;j<item.instances.length;j++)
			{
				options.series[i].data.push({x:item.instances[j].time, y:j+1, vm:item.instances[j].name})
			}
			
		});
		var chart = new Highcharts.Chart(options);	
		});

	   
	var options2 = {
	        chart: {
	        	zoomType: 'x',
	            renderTo: 'container2'
	        },
	        title: {
                text: 'Instance Applications History'
            },
            subtitle: {
                text: document.ontouchstart === undefined ?
                    'Click and drag in the plot area to zoom in' :
                    'Drag your finger over the plot to zoom in'
            },
	        xAxis: {
	            type:'datetime',
	            maxZoom: 14 * 24 * 3600000, // fourteen days
	            title: {
                    text: "Instance Application Dates"
                }
	        },
	        yAxis: {
	        	min: 0,
	            title: {
                    text: "Number of Applications"
                }
	        },
	        series: [{
	        	data: [],
	        	name: "Instance Applications"
	        }],
	        tooltip: {
	            shared: false,
	            formatter: function() {
	                var s = this.point.vm;
	                return '<b>'+s + '</b><hr/><br/><b>Filed: </b>' + new Date(this.point.x).toDateString() + '<br/>So far: ' + this.y;
	            }
	        }
	    };
	
	$.getJSON('{% url stats_ajax_apps %}', function(dt) {
		var items2 = [];
		$.each(dt, function(i, item) {
				options2.series[0].data.push({x:item.time, y:item.count, vm:item.instance, user:item.user})
			
			
		});
		var chart2 = new Highcharts.Chart(options2);	
		});
	
	
	{% for cluster in clusters %}
		
	var options_{{cluster.pk}} = {
			chart: {
                plotBackgroundColor: null,
                plotBorderWidth: null,
                plotShadow: false,
                renderTo: 'inst_vms_pie_{{cluster.pk}}'
            },
            title: {
                text: '{{cluster.slug}} instances'
            },
            tooltip: {
        	    pointFormat: '{series.name}: <b>{point.percentage}%</b>',
            	percentageDecimals: 1,
            	formatter: function() {
            		return '<b>'+ this.point.name +'</b>: '+ this.y + ' (' + Highcharts.numberFormat(this.percentage, 2) +' %)';
	            }
            },
            plotOptions: {
                pie: {
                    allowPointSelect: true,
                    cursor: 'pointer',
                    size: '100%',
                    dataLabels: {
                        enabled: false
                    },
                    showInLegend: true
                    /*dataLabels: {
                        enabled: true,
                        color: '#000000',
                        connectorColor: '#000000',
                        formatter: function() {
                            return '<b>'+ this.point.name +'</b>: '+ this.y + ' (' + Math.round(this.percentage) +' %)';
                        }
            		
                    }*/
                }
            },
            
            series: [{
                type: 'pie',
                name: '{{cluster.slug}}',
                data: [

                ]
            }]
            
	    };
	$.getJSON('{% url stats_ajax_vms_pc cluster.slug %}', function(dt) {
		
		options_{{cluster.pk}}.series[0].data.push({name:'Running', y:dt.instances.up, color: '#51A351'})
		options_{{cluster.pk}}.series[0].data.push({name:'Stopped', y:dt.instances.down, color: '#BD362F'})
			
		var chart_cluster_vms_{{cluster.pk}} = new Highcharts.Chart(options_{{cluster.pk}});
		});
		
	
	{% endfor %}

});

</script>

{% endblock %}
{% block title %}{% trans "Statistics" %}{% endblock %}
{% block statistics %}class="active"{% endblock %}
{% block statstop %}class="active"{% endblock %}
{% block crumbs %}
	<li><a href="{% url user-instances %}">{% trans "Home" %}</a><span class="divider">/</span></li>
	<li class="active">{% trans "Service Statistics" %}</li>
{% endblock %}
{% block content %}
<div class="span8">

    <div class="row-fluid">
        <div class="row-fluid">
            <h2>{% trans "ViMa Statistics" %}
            </h2>
            <div class="row-fluid">
{% for cluster in clusters %}

			<div class="span3" id="inst_vms_pie_{{cluster.pk}}" style="min-width: 300px; height: 300px; margin: 0 auto"></div>
			{% endfor %}
			</div>
            <div class="row-fluid">
<div id="container" style="width:100%; height:300px; float: none; margin: 0 auto;"></div>
</div>
<div class="row-fluid">
<div id="container2" style="width:100%; height:300px; float: none; margin: 0 auto;"></div>
</div>
<div class="row-fluid">
{% for cluster in clusters %}

			<div class="span3" id="inst_vms_pie_{{cluster.pk}}" style="min-width: 300px; height: 300px; margin: 0 auto"></div>
			{% endfor %}
			</div>
</div>
</div>
</div>
<div class="span4 sidebar">

        <div class="widget">
            <h2>{% trans "Platform Statistics" %}</h2>
            <ul class="cards">
                <li>
                    <p style=" line-height: 1em; margin-top: 0em" class="title">Clusters</p>
                    <p class="pull-right text-success strong">{{clusters|length}}</p>
                    <p class="info">Managed by ViMa</p>
                </li>
                <li>
                    <p style=" line-height: 1em; margin-top: 0em" class="title">Instances</p>
                    <p class="pull-right text-success strong">{{instances}}</p>
                    <p class="info">Created</p>
                </li>
                <li>
                    <p style=" line-height: 1em; margin-top: 0em" class="title">Applications</p>
                    <p class="pull-right text-info strong">{{instance_apps}}</p>
                    <p class="info">Filed</p>
                </li>                
                <li>
                    <p style=" line-height: 1em; margin-top: 0em" class="title">Users</p>
                    <p class="pull-right text-info strong">{{users}}</p>
                    <p class="info">Registered</p>
                </li>
                <li>
                    <p style=" line-height: 1em; margin-top: 0em" class="title">Groups</p>
                    <p class="pull-right text-info strong">{{groups}}</p>
                    <p class="info">Created</p>
                </li>
                <li>
                    <p style=" line-height: 1em; margin-top: 0em" class="title">Organizations</p>
                    <p class="pull-right text-info strong">{{orgs}}</p>
                    <p class="info">Participating</p>
                </li>
            </ul>
</div>
</div>
{% endblock %}
